# Асинхронное программирование
## Обзор асинхронной модели C#
В основе асинхронной модели лежат объекты Task и Task<T>, для которых можно применять ключевые слова async и await.
- В коде, ограниченном производительностью ввода-вывода, выполняйте await для операции, которая возвращает Task или Task<T>, внутри метода async.
- В коде, ограниченном ресурсами процессора, выполняйте await для операции, которая запускается в фоновом потоке методом Task.Run.

## Принцип работы асинхронного метода
- Ключевое слово async делает метод асинхронным, что позволяет использовтаь в его теле ключевое слово await,
- Когда применяется ключевое слово await, оно приостанавливает выполнение вызывающего метода и передает управление обратно вызывающему объекту, пока не будет завершена ожидаемая задача.
- await можно использовать только внутри асинхронного метода.

## Правильный выбор async await
1. Будет ли код "ожидать" чего-либо, например данных из БД? Если да, то это задача ограничена производительностью ввода-вывода.
Использовать необходимо async и await, Task.Run использовать не надо!
2. Будет ли код выполнять сложные вычисления? Если ответ утвердительный, то задача ограничена ресурсами процессора.
Использовать необходимо async-await, но перенести выполнение задачи в дополнительный поток, у которого есть Task.Run.
Также можно рассмотреть библиотеку параллельных задач, если к задаче можно применить параллелизм.

## Важные советы и сведения
- В методах async должно присутствовать ключевое слово await. В противном случае результат не будет получен,
- К имени каждого создаваемого асинхронного метода следует добавлять суффикс Async,
- async void следует использовать только для обработчиков событий,
- Быть осторожным при использовании асинхронных лябда-выражений в LINQ, так как для лябда-выражений в LINQ применяется отложенное выполнение,
- При написании кода ожидание задач следует реализовывать без блокировки.
[!async recomendations](./imgReadme/asn_rec_1.png)

- Если нужна производительность, использовать ValueTask во всех возможных случаях, кроме:
	- Повторного ожидания ValueTask или ValueTask<TResult>,
	- Параллельное ожидание ValueTask или ValueTask<TResult>,
	- Использовать .GetAwaiter().GetResult(), когда операция еще не завершилась.
- Рекомендуется использовать ConfigureAwait(false)
- Писать код с менее строгим отслеживанием состояния
**При применении ValueTask или ValueTask<TResult> вы должны либо await его непосредственно или вызвать AsTask() и больше его не использовать.**

## Выполнение асинхронного кода
https://docs.microsoft.com/ru-ru/dotnet/csharp/programming-guide/concepts/async/task-asynchronous-programming-model#what-happens-in-an-async-method.
- **Синхронный метод возвращает управление, когда его работа завершается, тогда как асинхронный метод возвращает управление, когда его работа приостанавливается. Когда асинхронный метод завершает работу, задача помечается как завершенная и результат, при его наличии, сохраняется в задаче.**
- **При попытке получить результат выполнения асинхронной операции при помощи свойства Result, вызывающий метод будет заблокирован до выполнения вызываемого метода.**

## Асинхронные потоки с IAsyncEnumerable<T>
Начиная с C# 8,0, асинхронный метод может возвращать асинхронный поток, представленный . Асинхронный поток позволяет перечислять элементы, считываемые из потока, при создании блоков элементов с помощью повторяющихся асинхронных вызовов. В следующем примере показан асинхронный метод, создающий асинхронный поток.
```
static async IAsyncEnumerable<string> ReadWordsFromStreamAsync()
{
    string data =
        @"This is a line of text.
          Here is the second line of text.
          And there is one more for good measure.
          Wait, that was the penultimate line.";

    using var readStream = new StringReader(data);

    string line = await readStream.ReadLineAsync();
    while (line != null)
    {
        foreach (string word in line.Split(' ', StringSplitOptions.RemoveEmptyEntries))
        {
            yield return word;
        }

        line = await readStream.ReadLineAsync();
    }
}
```
В предыдущем примере показано асинхронное считывание строк. После считывания каждой строки код перечисляет каждое слово в строке. Вызывающие объекты будут перечислять каждое слово с помощью оператора await foreach. Метод ожидает, когда необходимо асинхронно считать следующую строку из исходной строки.

